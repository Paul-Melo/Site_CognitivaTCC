from flask import Blueprint, request, redirect, url_for, session, jsonify
from google_auth_oauthlib.flow import Flow
from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build
import os

calendar_bp = Blueprint("calendar_bp", __name__)

# Configurações do OAuth 2.0
# ATENÇÃO: Em um ambiente de produção, essas credenciais devem ser carregadas de forma segura (variáveis de ambiente, KMS, etc.)
# Para fins de demonstração, estamos usando um arquivo JSON.
CLIENT_SECRETS_FILE = "client_secret.json" # Este arquivo precisa ser criado com suas credenciais do Google Cloud
SCOPES = ["https://www.googleapis.com/auth/calendar.events", "https://www.googleapis.com/auth/calendar.readonly"]

@calendar_bp.route("/authorize")
def authorize():
    flow = Flow.from_client_secrets_file(
        CLIENT_SECRETS_FILE,
        scopes=SCOPES,
        redirect_uri=url_for("calendar_bp.oauth2callback", _external=True)
    )

    authorization_url, state = flow.authorization_url(
        access_type='offline',
        include_granted_scopes='true'
    )

    session["oauth_state"] = state
    return redirect(authorization_url)

@calendar_bp.route("/oauth2callback")
def oauth2callback():
    state = session["oauth_state"]
    flow = Flow.from_client_secrets_file(
        CLIENT_SECRETS_FILE,
        scopes=SCOPES,
        state=state,
        redirect_uri=url_for("calendar_bp.oauth2callback", _external=True)
    )

    flow.fetch_token(authorization_response=request.url)

    credentials = flow.credentials
    session["credentials"] = {
        "token": credentials.token,
        "refresh_token": credentials.refresh_token,
        "token_uri": credentials.token_uri,
        "client_id": credentials.client_id,
        "client_secret": credentials.client_secret,
        "scopes": credentials.scopes
    }

    return jsonify({"message": "Autenticação bem-sucedida!"})

@calendar_bp.route("/create_event", methods=["POST"])
def create_event():
    if "credentials" not in session:
        return jsonify({"error": "Usuário não autenticado."}), 401

    credentials_data = session["credentials"]
    credentials = Credentials(**credentials_data)

    service = build("calendar", "v3", credentials=credentials)

    event = request.json
    # Exemplo de estrutura de evento:
    # event = {
    #     "summary": "Consulta de TCC - [Nome do Paciente]",
    #     "location": "Online",
    #     "description": "Sessão de Terapia Cognitivo-Comportamental.",
    #     "start": {
    #         "dateTime": "2025-12-25T09:00:00-03:00",
    #         "timeZone": "America/Sao_Paulo",
    #     },
    #     "end": {
    #         "dateTime": "2025-12-25T10:00:00-03:00",
    #         "timeZone": "America/Sao_Paulo",
    #     },
    #     "attendees": [
    #         {"email": "paciente@example.com"},
    #     ],
    #     "reminders": {
    #         "useDefault": False,
    #         "overrides": [
    #             {"method": "email", "minutes": 24 * 60},
    #             {"method": "popup", "minutes": 10},
    #         ],
    #     },
    # }

    try:
        event = service.events().insert(calendarId='primary', body=event).execute()
        return jsonify({"message": "Evento criado com sucesso!", "event_id": event["id"], "html_link": event["htmlLink"]})
    except Exception as e:
        return jsonify({"error": str(e)}), 500

@calendar_bp.route("/free_busy", methods=["POST"])
def free_busy():
    if "credentials" not in session:
        return jsonify({"error": "Usuário não autenticado."}), 401

    credentials_data = session["credentials"]
    credentials = Credentials(**credentials_data)

    service = build("calendar", "v3", credentials=credentials)

    time_min = request.json.get("timeMin")
    time_max = request.json.get("timeMax")
    items = request.json.get("items", [{'id': 'primary'}])

    body = {
        "timeMin": time_min,
        "timeMax": time_max,
        "items": items
    }

    try:
        events_result = service.freebusy().query(body=body).execute()
        calendars = events_result.get("calendars", {})
        return jsonify(calendars)
    except Exception as e:
        return jsonify({"error": str(e)}), 500



